<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تتبع اليد - الله أكبر</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: black;
      font-family: sans-serif;
    }

    canvas, video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      background-color: #0f0;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 10;
    }

    #message {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 48px;
      font-weight: bold;
      display: none;
      z-index: 20;
      text-shadow: 2px 2px 10px #000;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <button id="startButton">ابدأ التتبع</button>
  <video class="input_video" autoplay playsinline muted></video>
  <canvas class="output_canvas"></canvas>
  <div id="message">الله أكبر</div>

  <script>
    const videoElement = document.querySelector('.input_video');
    const canvasElement = document.querySelector('.output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const message = document.getElementById('message');
    const startButton = document.getElementById('startButton');

    let isMessageVisible = false;
    let lastTriggerTime = 0;

    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults(results => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      let showMessage = false;

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];

        drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#0f0', lineWidth: 3 });
        drawLandmarks(canvasCtx, landmarks, { color: '#f00', radius: 5 });

        const [indexTip, indexDip, middleTip, middlePip, ringTip, ringPip, pinkyTip, pinkyPip, thumbTip, thumbIp] = 
              [landmarks[8], landmarks[7], landmarks[12], landmarks[10], landmarks[16], landmarks[14], landmarks[20], landmarks[18], landmarks[4], landmarks[3]];

        const isIndexUp = indexTip.y < indexDip.y;
        const isMiddleDown = middleTip.y > middlePip.y;
        const isRingDown = ringTip.y > ringPip.y;
        const isPinkyDown = pinkyTip.y > pinkyPip.y;
        const isThumbNear = Math.abs(thumbTip.x - landmarks[2].x) < 0.1;

        if (isIndexUp && isMiddleDown && isRingDown && isPinkyDown && isThumbNear) {
          const now = Date.now();
          if (now - lastTriggerTime > 2000) {
            showMessage = true;
            lastTriggerTime = now;
          }
        }
      }

      message.style.display = showMessage ? 'block' : 'none';
      isMessageVisible = showMessage;

      canvasCtx.restore();
    });

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        await hands.send({ image: videoElement });
      },
      width: window.innerWidth,
      height: window.innerHeight
    });

    startButton.addEventListener('click', async () => {
      if (document.documentElement.requestFullscreen) {
        await document.documentElement.requestFullscreen();
      }
      startButton.style.display = 'none';
      camera.start();
    });

    window.addEventListener('resize', () => {
      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
    });
  </script>
</body>
</html>