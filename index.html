<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تتبع اليد والتعرف على الكوب</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: black;
    }

    canvas, video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
    }

    #message, #objectMessage {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 48px;
      font-weight: bold;
      z-index: 20;
      text-shadow: 2px 2px 10px #000;
      display: none;
    }

    #message {
      top: 50%;
      color: white;
    }

    #objectMessage {
      bottom: 10%;
      color: yellow;
    }
  </style>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- TensorFlow.js + COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
  <button id="startButton">ابدأ التتبع</button>
  <video class="input_video" autoplay playsinline muted></video>
  <canvas class="output_canvas"></canvas>
  <div id="message">الله أكبر</div>
  <div id="objectMessage">كوب</div>

  <script>
    const videoElement = document.querySelector('.input_video');
    const canvasElement = document.querySelector('.output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const message = document.getElementById('message');
    const objectMessage = document.getElementById('objectMessage');

    // MediaPipe - Hands
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults(results => {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      let showMessage = false;

      if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {
          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#0f0', lineWidth: 3 });
          drawLandmarks(canvasCtx, landmarks, { color: '#f00', radius: 5 });

          const indexTip = landmarks[8];
          const indexDip = landmarks[7];
          const middleTip = landmarks[12];
          const ringTip = landmarks[16];
          const pinkyTip = landmarks[20];
          const thumbTip = landmarks[4];
          const thumbIp = landmarks[3];

          const isIndexUp = indexTip.y < indexDip.y;
          const isMiddleDown = middleTip.y > landmarks[10].y;
          const isRingDown = ringTip.y > landmarks[14].y;
          const isPinkyDown = pinkyTip.y > landmarks[18].y;

          if (isIndexUp && isMiddleDown && isRingDown && isPinkyDown) {
            showMessage = true;
          }
        }
      }

      message.style.display = showMessage ? 'block' : 'none';
      canvasCtx.restore();
    });

    // Camera
    const camera = new Camera(videoElement, {
      onFrame: async () => {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        await hands.send({ image: videoElement });
        detectCup(); // كشف الكوب
      },
      width: window.innerWidth,
      height: window.innerHeight
    });

    // زر البدء
    document.getElementById('startButton').addEventListener('click', async () => {
      if (document.documentElement.requestFullscreen) {
        await document.documentElement.requestFullscreen();
      }
      document.getElementById('startButton').style.display = 'none';
      camera.start();
    });

    // COCO-SSD - التعرف على الكوب
    let objectModel;
    let detectingObjects = false;

    cocoSsd.load().then(model => {
      objectModel = model;
      console.log("تم تحميل نموذج التعرف على الكائنات");
    });

    async function detectCup() {
      if (!objectModel || detectingObjects) return;
      detectingObjects = true;

      const predictions = await objectModel.detect(videoElement);
      const foundCup = predictions.find(p => p.class === 'cup' && p.score > 0.6);

      objectMessage.style.display = foundCup ? 'block' : 'none';

      detectingObjects = false;
    }
  </script>
</body>
</html>