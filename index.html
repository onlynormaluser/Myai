<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>تحليل الحالة النفسية للطالب</title>
  <style>
    html, body {
      margin: 0; padding: 0; background: #111; color: white;
      font-family: 'Arial', sans-serif; direction: rtl;
    }
    video, canvas {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh; object-fit: cover; z-index: 0;
    }
    #statusBox {
      position: absolute; top: 20px; right: 20px;
      background: rgba(0,0,0,0.7); padding: 25px; border-radius: 18px;
      font-size: 30px; font-weight: bold; z-index: 10;
      max-width: 90vw;
    }
    #teacherBox {
      position: absolute; bottom: 30px; right: 30px;
      background: linear-gradient(45deg, #2e8b57, #3cb371);
      color: white; padding: 30px; border-radius: 25px;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      font-size: 26px; font-weight: bold;
      max-width: 90vw; line-height: 1.7;
      z-index: 10;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <div id="statusBox">الحالة النفسية: جاري التحليل...</div>
  <div id="teacherBox">الطالب: جاري التقييم...</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusBox = document.getElementById('statusBox');
    const teacherBox = document.getElementById('teacherBox');
    const blinkHistory = Array(30).fill(false);

    function distance(a, b) {
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function randomFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function analyzeState(landmarks) {
      const rightEyeOpen = distance(landmarks[159], landmarks[145]) > 0.015;
      const leftEyeOpen = distance(landmarks[386], landmarks[374]) > 0.015;
      const mouthOpen = distance(landmarks[13], landmarks[14]) > 0.035;

      const blinked = !rightEyeOpen && !leftEyeOpen;
      blinkHistory.shift(); blinkHistory.push(blinked);

      const blinkRate = blinkHistory.filter(b => b).length / blinkHistory.length;
      const headStability = Math.abs(landmarks[10].x - landmarks[152].x) < 0.005;

      if (blinkRate < 0.1 && headStability && !mouthOpen) {
        return {
          state: "نائم أو شارد",
          advice: randomFrom([
            "الطالب يبدو مرهقًا — يُنصح بإعطائه دقيقة راحة.",
            "ربما يحتاج إلى استراحة قصيرة ليعود إلى التركيز.",
            "يشير وضع الطالب إلى النعاس — جرّب طرح سؤال بسيط لإيقاظه بلطف."
          ])
        };
      }
      if (mouthOpen && blinkRate > 0.3) {
        return {
          state: "متوتر أو قلق",
          advice: randomFrom([
            "الطالب متوتر — استخدم نبرة مطمئنة.",
            "أظهر للطالب أنك تدعمه، فقد يكون قلقًا.",
            "التوتر ظاهر عليه — تواصل معه بهدوء."
          ])
        };
      }
      if (!mouthOpen && blinkRate > 0.4) {
        return {
          state: "تعب خفيف",
          advice: randomFrom([
            "بحاجة إلى دفعة تشجيعية — قل له: أحسنت!",
            "طالبك يبدُو مُتعبًا قليلًا، امدحه ليرتفع حماسه.",
            "التعب واضح، حفّزه بكلمة طيبة."
          ])
        };
      }
      if (!mouthOpen && rightEyeOpen && leftEyeOpen) {
        return {
          state: "مركز ومطمئن",
          advice: randomFrom([
            "الطالب مركز — أحسنت في إدارتك للدرس!",
            "التركيز واضح عليه — استمر بنفس الإيقاع.",
            "ممتاز، الطالب يظهر عليه الهدوء والانتباه."
          ])
        };
      }

      return {
        state: "جارٍ التحليل",
        advice: "الطالب: جاري التقييم..."
      };
    }

    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults(results => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        drawConnectors(ctx, landmarks, FACEMESH_TESSELATION, { color: 'rgba(0,255,0,0.3)', lineWidth: 1 });
        drawLandmarks(ctx, landmarks, { color: 'red', radius: 1.5 });

        const analysis = analyzeState(landmarks);
        statusBox.textContent = `الحالة النفسية: ${analysis.state}`;
        teacherBox.textContent = `الطالب: ${analysis.advice}`;
      } else {
        statusBox.textContent = "الحالة النفسية: لا يوجد وجه";
        teacherBox.textContent = "الطالب: غير ظاهر أمام الكاميرا";
      }
    });

    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }, audio: false
    }).then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        function loop() {
          faceMesh.send({ image: video });
          requestAnimationFrame(loop);
        }
        loop();
      };
    }).catch(err => {
      alert("تعذر الوصول إلى الكاميرا الخلفية: " + err.message);
    });
  </script>
</body>
</html>